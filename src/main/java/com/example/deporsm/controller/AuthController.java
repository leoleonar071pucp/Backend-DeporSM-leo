package com.example.deporsm.controller;

import com.example.deporsm.model.LoginRequest;
import com.example.deporsm.model.Usuario;
import com.example.deporsm.model.PasswordChangeRequest;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.*;

import org.springframework.security.core.Authentication;
import java.util.Map;


@RestController
@RequestMapping("/api/auth")
@CrossOrigin(
  origins = {
    "https://deporsm-apiwith-1035693188565.us-central1.run.app",
    "https://frontend-depor-sm-leo.vercel.app",
    "http://localhost:3000"
  },
  allowCredentials = "true"
)
public class AuthController {
    
    @Autowired
    private com.example.deporsm.service.AuthService authService;

    @Autowired
    private AuthenticationManager authenticationManager;

    @PostMapping("/login")
    public ResponseEntity<Usuario> login(@RequestBody LoginRequest request, HttpServletRequest servletRequest, HttpServletResponse response) {
        System.out.println("üì• Intentando login para: " + request.getEmail());

        try {
            UsernamePasswordAuthenticationToken authToken =
                    new UsernamePasswordAuthenticationToken(request.getEmail(), request.getPassword());

            Authentication authentication = authenticationManager.authenticate(authToken);
            SecurityContextHolder.getContext().setAuthentication(authentication);            // Forzar la creaci√≥n de una sesi√≥n si no existe
            HttpSession session = servletRequest.getSession(true);
            session.setMaxInactiveInterval(86400); // Sesi√≥n v√°lida por 24 horas (86400 segundos)
            
            // Guardar expl√≠citamente el contexto de seguridad en la sesi√≥n para mejor persistencia
            session.setAttribute("SPRING_SECURITY_CONTEXT", SecurityContextHolder.getContext());

            Usuario usuario = authService.findByEmail(request.getEmail());

            System.out.println("‚úÖ Login exitoso para: " + request.getEmail());
            System.out.println("üç™ ID de sesi√≥n: " + session.getId());

            return ResponseEntity.ok(usuario);
        } catch (Exception e) {
            System.out.println("‚ùå Error en login: " + e.getMessage());
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
        }
    }

    @GetMapping("/me")
    public ResponseEntity<Usuario> getCurrentUser(HttpServletRequest request) {
        System.out.println("üß† Obteniendo usuario desde sesi√≥n...");

        try {
            // Intenta obtener la autenticaci√≥n directamente del contexto de seguridad
            Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
            
            if (authentication == null || !authentication.isAuthenticated() 
                || authentication.getPrincipal().equals("anonymousUser")) {
                System.out.println("üö´ Usuario no autenticado o an√≥nimo");
                return ResponseEntity.status(401).build();
            }
            
            // Obtener el email del usuario autenticado
            String email = authentication.getName();
            System.out.println("üìß Email encontrado: " + email);
            
            // Obtener usuario de la base de datos
            Usuario usuario = authService.findByEmail(email);
            
            if (usuario == null) {
                System.out.println("‚ùì No se encontr√≥ usuario con email: " + email);
                return ResponseEntity.status(401).build();
            }
            
            System.out.println("‚úÖ Usuario autenticado: " + usuario.getEmail() + ", rol: " + usuario.getRol().getNombre());
            return ResponseEntity.ok(usuario);
        } catch (Exception e) {
            System.out.println("‚ùå Error al obtener usuario: " + e.getMessage());
            e.printStackTrace(); // Imprime el stack trace para depuraci√≥n
            return ResponseEntity.status(500).build();
        }
    }

    @PostMapping("/change-password")
    public ResponseEntity<?> changePassword(@RequestBody PasswordChangeRequest request) {
        System.out.println("üìù Intentando cambiar contrase√±a...");
        
        try {
            // Obtener el usuario autenticado actual
            Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
            
            if (authentication == null || !authentication.isAuthenticated() 
                || authentication.getPrincipal().equals("anonymousUser")) {
                System.out.println("üö´ Usuario no autenticado o an√≥nimo");
                return ResponseEntity.status(401).build();
            }
            
            String email = authentication.getName();
            System.out.println("üìß Cambiando contrase√±a para: " + email);
            
            // Intentar cambiar la contrase√±a
            boolean passwordChanged = authService.changePassword(
                email, 
                request.getCurrentPassword(),
                request.getNewPassword()
            );
            
            if (passwordChanged) {
                System.out.println("‚úÖ Contrase√±a actualizada correctamente");
                return ResponseEntity.ok().body(Map.of("message", "Contrase√±a actualizada correctamente"));
            } else {
                System.out.println("‚ùå Error al actualizar contrase√±a: La contrase√±a actual no es v√°lida");
                return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Map.of("error", "La contrase√±a actual no es v√°lida"));
            }
        } catch (Exception e) {
            System.out.println("‚ùå Error al cambiar contrase√±a: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(500).body(Map.of("error", "Error al cambiar la contrase√±a: " + e.getMessage()));
        }
    }

    // Eliminamos el m√©todo logout para evitar conflictos con Spring Security
    // Spring Security manejar√° autom√°ticamente las peticiones a /api/auth/logout
}